<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>教你从写一个迷你koa-router到阅读koa-router源码 | 个人主页</title>
    <meta name="description" content="一个互联网全才妹子，会设计，会前端，会后端，还会视频动效，好像并没有什么卵用。。。。。。。">
    
    
    <link rel="preload" href="/blog/assets/css/styles.b8f6f876.css" as="style"><link rel="preload" href="/blog/assets/js/app.b8f6f876.js" as="script"><link rel="preload" href="/blog/assets/js/22.4efd32d6.js" as="script"><link rel="prefetch" href="/blog/assets/css/1.styles.8e8fe409.css"><link rel="prefetch" href="/blog/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/blog/assets/js/1.8e8fe409.js"><link rel="prefetch" href="/blog/assets/js/10.619c7997.js"><link rel="prefetch" href="/blog/assets/js/11.9c3e970b.js"><link rel="prefetch" href="/blog/assets/js/12.531cd467.js"><link rel="prefetch" href="/blog/assets/js/13.7e326423.js"><link rel="prefetch" href="/blog/assets/js/14.f3b097e0.js"><link rel="prefetch" href="/blog/assets/js/15.6a2e75f0.js"><link rel="prefetch" href="/blog/assets/js/16.c206d890.js"><link rel="prefetch" href="/blog/assets/js/17.cff55b68.js"><link rel="prefetch" href="/blog/assets/js/18.cbfbf9aa.js"><link rel="prefetch" href="/blog/assets/js/19.96969ef1.js"><link rel="prefetch" href="/blog/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/blog/assets/js/20.357307bb.js"><link rel="prefetch" href="/blog/assets/js/21.69c3455f.js"><link rel="prefetch" href="/blog/assets/js/23.f297491c.js"><link rel="prefetch" href="/blog/assets/js/24.cc9b4c20.js"><link rel="prefetch" href="/blog/assets/js/25.ee8d1b0e.js"><link rel="prefetch" href="/blog/assets/js/26.762d7fbf.js"><link rel="prefetch" href="/blog/assets/js/27.3a122b7f.js"><link rel="prefetch" href="/blog/assets/js/28.2175adc1.js"><link rel="prefetch" href="/blog/assets/js/29.ebb9d56c.js"><link rel="prefetch" href="/blog/assets/js/3.7e0f7a9a.js"><link rel="prefetch" href="/blog/assets/js/30.73a02a6b.js"><link rel="prefetch" href="/blog/assets/js/31.1eae61bd.js"><link rel="prefetch" href="/blog/assets/js/32.c07b58b2.js"><link rel="prefetch" href="/blog/assets/js/33.397eaa54.js"><link rel="prefetch" href="/blog/assets/js/34.51ce988a.js"><link rel="prefetch" href="/blog/assets/js/35.58456503.js"><link rel="prefetch" href="/blog/assets/js/36.608991b7.js"><link rel="prefetch" href="/blog/assets/js/4.66ec0ecb.js"><link rel="prefetch" href="/blog/assets/js/5.38cc5d58.js"><link rel="prefetch" href="/blog/assets/js/6.ce65520e.js"><link rel="prefetch" href="/blog/assets/js/7.705c84c4.js"><link rel="prefetch" href="/blog/assets/js/8.95f0bebe.js"><link rel="prefetch" href="/blog/assets/js/9.291ac53a.js">
    <link rel="stylesheet" href="/blog/assets/css/1.styles.8e8fe409.css"><link rel="stylesheet" href="/blog/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/blog/assets/css/styles.b8f6f876.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links" style="max-width:nullpx;"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">主页</a></div><div class="nav-item"><a href="/blog/home/" class="nav-link">vue源码解读</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">webpack源码解读</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link router-link-active">koa源码解析</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">JS基础</a></div><div class="nav-item"><a href="/blog/source/" class="nav-link">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/interview/" class="nav-link">面试题</a></li><li class="dropdown-item"><!----> <a href="/blog/essay/" class="nav-link">随想</a></li><li class="dropdown-item"><!----> <a href="https://saintgirl.zcool.com.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  设计
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Carrie999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">主页</a></div><div class="nav-item"><a href="/blog/home/" class="nav-link">vue源码解读</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">webpack源码解读</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link router-link-active">koa源码解析</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">JS基础</a></div><div class="nav-item"><a href="/blog/source/" class="nav-link">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/interview/" class="nav-link">面试题</a></li><li class="dropdown-item"><!----> <a href="/blog/essay/" class="nav-link">随想</a></li><li class="dropdown-item"><!----> <a href="https://saintgirl.zcool.com.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  设计
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Carrie999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>koa源码解析</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/node/" class="sidebar-link">Koa源码阅读-中间件原理分析</a></li><li><a href="/blog/node/koa.html" class="sidebar-link">Koa源码阅读-详解</a></li><li><a href="/blog/node/koa-router.html" class="active sidebar-link">教你从写一个迷你koa-router到阅读koa-router源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#最核心需求-路由匹配" class="sidebar-link">最核心需求-路由匹配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#先分析" class="sidebar-link">先分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#读源码" class="sidebar-link">读源码</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#需求实现" class="sidebar-link">需求实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#实现匹配" class="sidebar-link">实现匹配</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#写法的多样性" class="sidebar-link">写法的多样性</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#支持中间件" class="sidebar-link">支持中间件</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#多层嵌套" class="sidebar-link">多层嵌套</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#路径前缀（router-prefixes）" class="sidebar-link">路径前缀（Router prefixes）</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#url-parameters" class="sidebar-link">URL parameters</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#router-js" class="sidebar-link">router.js</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#param" class="sidebar-link">param</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#params" class="sidebar-link">params</a></li><li class="sidebar-sub-header"><a href="/blog/node/koa-router.html#尾声" class="sidebar-link">尾声</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#最核心需求-路由匹配">最核心需求-路由匹配</a><ul><li><a href="#先分析">先分析</a></li></ul></li><li><a href="#读源码">读源码</a></li><li><a href="#需求实现">需求实现</a><ul><li><a href="#实现匹配">实现匹配</a></li><li><a href="#写法的多样性">写法的多样性</a></li><li><a href="#支持中间件">支持中间件</a></li><li><a href="#多层嵌套">多层嵌套</a></li><li><a href="#路径前缀（router-prefixes）">路径前缀（Router prefixes）</a></li><li><a href="#url-parameters">URL parameters</a></li></ul></li><li><a href="#router-js">router.js</a></li><li><a href="#param">param</a></li><li><a href="#params">params</a></li><li><a href="#尾声">尾声</a></li></ul></div><p></p> <h1 id="教你从写一个迷你koa-router到阅读koa-router源码"><a href="#教你从写一个迷你koa-router到阅读koa-router源码" aria-hidden="true" class="header-anchor">#</a> 教你从写一个迷你koa-router到阅读koa-router源码</h1> <p>本打算教一步步实现koa-router，因为要解释的太多了，所以先简化成mini版本，从实现部分功能到阅读源码，希望能让你好理解一些。
希望你之前有读过koa源码，没有的话，给你<a href="https://carrie999.github.io/blog/node/" target="_blank" rel="noopener noreferrer">链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="最核心需求-路由匹配"><a href="#最核心需求-路由匹配" aria-hidden="true" class="header-anchor">#</a> 最核心需求-路由匹配</h2> <p>router最重要的就是路由匹配，我们就从最核心的入手</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/string'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'koa2 string'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/json'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'koa2 json'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们希望</p> <ul><li>路径访问 /string 页面显示 'koa2 string'</li> <li>路径访问 /json 页面显示 'koa2 json'</li></ul> <h3 id="先分析"><a href="#先分析" aria-hidden="true" class="header-anchor">#</a> 先分析</h3> <h5 id="收集开发者输入的信息配置"><a href="#收集开发者输入的信息配置" aria-hidden="true" class="header-anchor">#</a> 收集开发者输入的信息配置</h5> <p>1.我们需要一个数组，数组里每个都是一个对象，每个对象包含路径，方法，函数，传参等信息
这个数组我们起个名字叫stack</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p>2.对于每一个对象，我们起名叫layer
我们把它定义成一个函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Layer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>我们把页面比喻成一个箱子，箱子是对外的，箱子需要有入口，需要容纳。把每一个router比作放在箱子里的物件，物件是内部的</p> <p>定义两个js页面，router.js做为入口，对于当前页面的访问的处理，layer.js包含开发者已经约定好的规则</p> <p>router.js</p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = Router;

function Router(opts) {
  // 容纳layer层
  this.stack = [];
};
</code></pre></div><p>layer.js</p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = Layer;

function Layer() {

};
</code></pre></div><p>我们在Router要放上许多方法，我们可以在Router内部挂载方法，也可以在原型上挂载函数</p> <p>但是要考虑多可能Router要被多次实例化，这样里面都要开辟一份新的空间，挂载在原型就是同一份空间。
最终决定挂载在原型上</p> <p>方法有很多，我们先实现约定几个常用的吧</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token string">'post'</span><span class="token punctuation">,</span>
  <span class="token string">'put'</span><span class="token punctuation">,</span>
  <span class="token string">'head'</span><span class="token punctuation">,</span>
  <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token string">'options'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Router<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>middleware<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 对于path,middleware，我们需要把它交给layer，拿到layer返回的结果</span>
    <span class="token comment">// 这里交给另一个函数来是实现，我们叫它register就是暂存的意思</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">,</span> middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为get还可以继续get，我们返回this</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="实现layer的沟通"><a href="#实现layer的沟通" aria-hidden="true" class="header-anchor">#</a> 实现layer的沟通</h4> <div class="language-js extra-class"><pre class="language-js"><code>Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
  <span class="token keyword">let</span> route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> route
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们先去写layer</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> pathToRegExp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path-to-regexp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Layer</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把方法名称放到methods数组里</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// stack盛放中间件函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token operator">?</span> middleware <span class="token punctuation">:</span> <span class="token punctuation">[</span>middleware<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 路径</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token comment">// 对于这个路径生成匹配规则，这里借助第三方</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>regexp <span class="token operator">=</span> <span class="token function">pathToRegExp</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// methods</span>
  methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绑定layer的this，不然匿名函数的this指向window</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 给一个原型方法match匹配返回true</span>
Layer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">match</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>回到router层</p> <p>定义match方法,根据Developer传入的path, method返回 一个对象(包括是否匹配，匹配成功layer，和匹配成功的方法)</p> <div class="language-js extra-class"><pre class="language-js"><code>Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">match</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>path<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> layers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
  <span class="token keyword">let</span> layer<span class="token punctuation">;</span>
  <span class="token keyword">const</span> matched <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pathAndMethod<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    route<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token comment">//循环寄存好的stack层的每一个layer</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> len <span class="token operator">=</span> layers<span class="token punctuation">.</span>length<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    layer <span class="token operator">=</span> layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//layer是提前存好的路径， path是过来的path</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// layer放入path，为什么不把path传入，一是path已经没用了，匹配了就够了，layer含有更多信息需要用</span>
      matched<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果methods什么也没写，或者如果方法里含有你的过来的方法，那么把layer放入pathAndMethod</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">~</span>layer<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        matched<span class="token punctuation">.</span>pathAndMethod<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 路径匹配，并且有方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>length<span class="token punctuation">)</span> matched<span class="token punctuation">.</span>route <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> matched<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>给Developer一个方法</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>index<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这里不考虑传多个id，和多次匹配情况，拿到匹配的函数</p> <div class="language-js extra-class"><pre class="language-js"><code>Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">routes</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path
    <span class="token keyword">const</span> method <span class="token operator">=</span> ctx<span class="token punctuation">.</span>method
    <span class="token keyword">const</span> matched <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matched<span class="token punctuation">.</span>route<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> matchedLayers <span class="token operator">=</span> matched<span class="token punctuation">.</span>pathAndMethod
    <span class="token comment">// 先不考虑多matchedLayers多stack情况</span>
    <span class="token keyword">return</span> matchedLayers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>stack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> dispatch
<span class="token punctuation">}</span>
</code></pre></div><p>此时一个迷你koa-router已经实现了</p> <h2 id="读源码"><a href="#读源码" aria-hidden="true" class="header-anchor">#</a> 读源码</h2> <h2 id="需求实现"><a href="#需求实现" aria-hidden="true" class="header-anchor">#</a> 需求实现</h2> <h3 id="实现匹配"><a href="#实现匹配" aria-hidden="true" class="header-anchor">#</a> 实现匹配</h3> <p>方法名匹配，路径匹配，还要满足动态参数的传递</p> <p>并且还要给很懒的开发者一个router.all()
也就是说不用区分方法了🙄</p> <div class="language-js extra-class"><pre class="language-js"><code> router
    <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="写法的多样性"><a href="#写法的多样性" aria-hidden="true" class="header-anchor">#</a> 写法的多样性</h3> <p>为了方便众多的开发者使用</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
router<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如下写法
都是一个路径</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// =&gt; &quot;/users/3&quot;</span>
</code></pre></div><h3 id="支持中间件"><a href="#支持中间件" aria-hidden="true" class="header-anchor">#</a> 支持中间件</h3> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
    <span class="token string">'/users/:id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>  
            ctx<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    ctx <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// =&gt; { id: 17, name: &quot;Alex&quot; }</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="多层嵌套"><a href="#多层嵌套" aria-hidden="true" class="header-anchor">#</a> 多层嵌套</h3> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">var</span> forums <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> posts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 posts<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 posts<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:pid'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 forums<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/forums/:fid/posts'</span><span class="token punctuation">,</span> posts<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> posts<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//responds to &quot;/forums/123/posts&quot; and &quot;/forums/123/posts/123&quot;</span>
 app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>forums<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="路径前缀（router-prefixes）"><a href="#路径前缀（router-prefixes）" aria-hidden="true" class="header-anchor">#</a> 路径前缀（Router prefixes）</h3> <div class="language- extra-class"><pre class="language-text"><code>var router = new Router({
     prefix: '/users'
});
router.get('/', ...); 
// responds to &quot;/users&quot;
router.get('/:id', ...); 
// responds to &quot;/users/:id&quot;
</code></pre></div><h3 id="url-parameters"><a href="#url-parameters" aria-hidden="true" class="header-anchor">#</a> URL parameters</h3> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:category/:title'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// =&gt; { category: 'programming', title: 'how-to-node' }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="router-js"><a href="#router-js" aria-hidden="true" class="header-anchor">#</a> router.js</h2> <div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Router<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> middleware<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> path <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 第二个参数是否是路径，如果是路径字符串那么从下表[2]开始才是中间件</span>
      middleware <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      path <span class="token operator">=</span> name<span class="token punctuation">;</span>
      name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//别名</span>
Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>del <span class="token operator">=</span> Router<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>methods引用第三方包含</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getBasicNodeMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string">'get'</span><span class="token punctuation">,</span>
    <span class="token string">'post'</span><span class="token punctuation">,</span>
    <span class="token string">'put'</span><span class="token punctuation">,</span>
    <span class="token string">'head'</span><span class="token punctuation">,</span>
    <span class="token string">'delete'</span><span class="token punctuation">,</span>
    <span class="token string">'options'</span><span class="token punctuation">,</span>
    <span class="token string">'trace'</span><span class="token punctuation">,</span>
    <span class="token string">'copy'</span><span class="token punctuation">,</span>
    <span class="token string">'lock'</span><span class="token punctuation">,</span>
    <span class="token string">'mkcol'</span><span class="token punctuation">,</span>
    <span class="token string">'move'</span><span class="token punctuation">,</span>
    <span class="token string">'purge'</span><span class="token punctuation">,</span>
    <span class="token string">'propfind'</span><span class="token punctuation">,</span>
    <span class="token string">'proppatch'</span><span class="token punctuation">,</span>
    <span class="token string">'unlock'</span><span class="token punctuation">,</span>
    <span class="token string">'report'</span><span class="token punctuation">,</span>
    <span class="token string">'mkactivity'</span><span class="token punctuation">,</span>
    <span class="token string">'checkout'</span><span class="token punctuation">,</span>
    <span class="token string">'merge'</span><span class="token punctuation">,</span>
    <span class="token string">'m-search'</span><span class="token punctuation">,</span>
    <span class="token string">'notify'</span><span class="token punctuation">,</span>
    <span class="token string">'subscribe'</span><span class="token punctuation">,</span>
    <span class="token string">'unsubscribe'</span><span class="token punctuation">,</span>
    <span class="token string">'patch'</span><span class="token punctuation">,</span>
    <span class="token string">'search'</span><span class="token punctuation">,</span>
    <span class="token string">'connect'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>routes <span class="token operator">=</span> Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> router<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>routerPath <span class="token operator">||</span> ctx<span class="token punctuation">.</span>routerPath <span class="token operator">||</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token keyword">var</span> matched <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> layerChain<span class="token punctuation">,</span> layer<span class="token punctuation">,</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>matched<span class="token punctuation">,</span> matched<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>matched <span class="token operator">=</span> matched<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ctx挂载router</span>
    ctx<span class="token punctuation">.</span>router <span class="token operator">=</span> router<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matched<span class="token punctuation">.</span>route<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到既匹配到路径又匹配到方法的layer</span>
    <span class="token keyword">var</span> matchedLayers <span class="token operator">=</span> matched<span class="token punctuation">.</span>pathAndMethod
    <span class="token comment">// 取出最后一个layer</span>
    <span class="token keyword">var</span> mostSpecificLayer <span class="token operator">=</span> matchedLayers<span class="token punctuation">[</span>matchedLayers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// 挂载_matchedRoute属性</span>
    ctx<span class="token punctuation">.</span>_matchedRoute <span class="token operator">=</span> mostSpecificLayer<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token comment">// 如果有name,既如下写法会有name, name是string</span>
    <span class="token comment">// router.get('/string','/string/:1',async (ctx, next) =&gt; {</span>
    <span class="token comment">//   ctx.body = 'koa2 string'</span>
    <span class="token comment">// })</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mostSpecificLayer<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 挂载_matchedRouteName属性</span>
      ctx<span class="token punctuation">.</span>_matchedRouteName <span class="token operator">=</span> mostSpecificLayer<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// layerChain就是中间件数组，目前是两个函数</span>
    layerChain <span class="token operator">=</span> matchedLayers<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>memo<span class="token punctuation">,</span> layer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      memo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>captures <span class="token operator">=</span> layer<span class="token punctuation">.</span><span class="token function">captures</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>captures<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>params <span class="token operator">=</span> layer<span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>captures<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// console.log('captures2', ctx.captures)</span>
        <span class="token comment">// ctx.captures是 :id 的捕捉，正则匹配slice截取得到</span>
        <span class="token comment">// ctx.params是对象 {id:1}</span>
        ctx<span class="token punctuation">.</span>routerName <span class="token operator">=</span> layer<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>layer<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 中间件调用layerChain</span>
    <span class="token keyword">return</span> <span class="token function">compose</span><span class="token punctuation">(</span>layerChain<span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// routes挂载router对象</span>
  dispatch<span class="token punctuation">.</span>router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 每次调用routes返回一个dispatch函数(layer.stack和memo)，函数还有一个属于这个路径下的router属性对象</span>
  <span class="token keyword">return</span> dispatch<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>这里使用compose-koa中间件的方式来处理传递多个函数和多种匹配的情况
captures和params  处理自定义路径传参</p> <h2 id="param"><a href="#param" aria-hidden="true" class="header-anchor">#</a> param</h2> <p>实现如下需求，访问/users/:1
在param中能拿到user</p> <div class="language-js extra-class"><pre class="language-js"><code>router
  <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/users/:user'</span><span class="token punctuation">,</span> ctx <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>Router<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">param</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>param<span class="token punctuation">,</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span> <span class="token operator">=</span> middleware<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>Layer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">param</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>param<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> stack <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
  <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 第一个参数是 ctx.params[param], params拿到了user</span>
    <span class="token keyword">return</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="params"><a href="#params" aria-hidden="true" class="header-anchor">#</a> params</h2> <p>实现如下需求</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:category/:title'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// =&gt; { category: 'programming', title: 'how-to-node' }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>例子</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/string/:id'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'koa2 string'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>访问  string/1</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 拿到{id:1}</span>
ctx<span class="token punctuation">.</span>params <span class="token operator">=</span> layer<span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>captures<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

  
Layer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">params</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>path<span class="token punctuation">,</span> captures<span class="token punctuation">,</span> existingParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> params <span class="token operator">=</span> existingParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> len <span class="token operator">=</span> captures<span class="token punctuation">.</span>length<span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> c <span class="token operator">=</span> captures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 找到name赋值</span>
      params<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> c <span class="token operator">?</span> <span class="token function">safeDecodeURIComponent</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">:</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回{id:1}</span>
  <span class="token keyword">return</span> params<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>有兴趣的可以研究一下allowedMethods，prefix，use，redirect等原型方法，这里已经把最核心的展示了，至此，koa源码系列解读完毕。</p> <h2 id="尾声"><a href="#尾声" aria-hidden="true" class="header-anchor">#</a> 尾声</h2> <p>从vue源码读到webpack再到koa，深感源码架构的有趣，比做业务有趣太多，有意义太多。
以后源码阅读应该不会记录blog了，这样学起来太慢了。当然也会继续研究源码。
<br>
我觉得程序员不做开源不去github贡献源码的人生是没有意义的。
<br>
不想当将军的士兵不是好士兵。
<br>
所以以后大部分时间会去做开源，谢谢阅读。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/node/koa.html" class="prev">
          Koa源码阅读-详解
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/22.4efd32d6.js" defer></script><script src="/blog/assets/js/app.b8f6f876.js" defer></script>
  </body>
</html>
