<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>读marked.js源码 -- markdown是怎么变成html的 | 个人主页</title>
    <meta name="description" content="一个互联网全才妹子，会设计，会前端，会后端，还会视频动效，好像并没有什么卵用。。。。。。。">
    
    
    <link rel="preload" href="/blog/assets/css/styles.b8f6f876.css" as="style"><link rel="preload" href="/blog/assets/js/app.b8f6f876.js" as="script"><link rel="preload" href="/blog/assets/js/24.cc9b4c20.js" as="script"><link rel="prefetch" href="/blog/assets/css/1.styles.8e8fe409.css"><link rel="prefetch" href="/blog/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/blog/assets/js/1.8e8fe409.js"><link rel="prefetch" href="/blog/assets/js/10.619c7997.js"><link rel="prefetch" href="/blog/assets/js/11.9c3e970b.js"><link rel="prefetch" href="/blog/assets/js/12.531cd467.js"><link rel="prefetch" href="/blog/assets/js/13.7e326423.js"><link rel="prefetch" href="/blog/assets/js/14.f3b097e0.js"><link rel="prefetch" href="/blog/assets/js/15.6a2e75f0.js"><link rel="prefetch" href="/blog/assets/js/16.c206d890.js"><link rel="prefetch" href="/blog/assets/js/17.cff55b68.js"><link rel="prefetch" href="/blog/assets/js/18.cbfbf9aa.js"><link rel="prefetch" href="/blog/assets/js/19.96969ef1.js"><link rel="prefetch" href="/blog/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/blog/assets/js/20.357307bb.js"><link rel="prefetch" href="/blog/assets/js/21.69c3455f.js"><link rel="prefetch" href="/blog/assets/js/22.4efd32d6.js"><link rel="prefetch" href="/blog/assets/js/23.f297491c.js"><link rel="prefetch" href="/blog/assets/js/25.ee8d1b0e.js"><link rel="prefetch" href="/blog/assets/js/26.762d7fbf.js"><link rel="prefetch" href="/blog/assets/js/27.3a122b7f.js"><link rel="prefetch" href="/blog/assets/js/28.2175adc1.js"><link rel="prefetch" href="/blog/assets/js/29.ebb9d56c.js"><link rel="prefetch" href="/blog/assets/js/3.7e0f7a9a.js"><link rel="prefetch" href="/blog/assets/js/30.73a02a6b.js"><link rel="prefetch" href="/blog/assets/js/31.1eae61bd.js"><link rel="prefetch" href="/blog/assets/js/32.c07b58b2.js"><link rel="prefetch" href="/blog/assets/js/33.397eaa54.js"><link rel="prefetch" href="/blog/assets/js/34.51ce988a.js"><link rel="prefetch" href="/blog/assets/js/35.58456503.js"><link rel="prefetch" href="/blog/assets/js/36.608991b7.js"><link rel="prefetch" href="/blog/assets/js/4.66ec0ecb.js"><link rel="prefetch" href="/blog/assets/js/5.38cc5d58.js"><link rel="prefetch" href="/blog/assets/js/6.ce65520e.js"><link rel="prefetch" href="/blog/assets/js/7.705c84c4.js"><link rel="prefetch" href="/blog/assets/js/8.95f0bebe.js"><link rel="prefetch" href="/blog/assets/js/9.291ac53a.js">
    <link rel="stylesheet" href="/blog/assets/css/1.styles.8e8fe409.css"><link rel="stylesheet" href="/blog/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/blog/assets/css/styles.b8f6f876.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links" style="max-width:nullpx;"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">主页</a></div><div class="nav-item"><a href="/blog/home/" class="nav-link">vue源码解读</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">webpack源码解读</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">koa源码解析</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">JS基础</a></div><div class="nav-item"><a href="/blog/source/" class="nav-link router-link-exact-active router-link-active">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/interview/" class="nav-link">面试题</a></li><li class="dropdown-item"><!----> <a href="/blog/essay/" class="nav-link">随想</a></li><li class="dropdown-item"><!----> <a href="https://saintgirl.zcool.com.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  设计
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Carrie999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">主页</a></div><div class="nav-item"><a href="/blog/home/" class="nav-link">vue源码解读</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">webpack源码解读</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">koa源码解析</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">JS基础</a></div><div class="nav-item"><a href="/blog/source/" class="nav-link router-link-exact-active router-link-active">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/interview/" class="nav-link">面试题</a></li><li class="dropdown-item"><!----> <a href="/blog/essay/" class="nav-link">随想</a></li><li class="dropdown-item"><!----> <a href="https://saintgirl.zcool.com.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  设计
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Carrie999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>读源码,造轮子</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/source/" class="active sidebar-link">读marked.js源码 -- markdown是怎么变成html的</a></li><li><a href="/blog/source/react-beauty-highcharts.html" class="sidebar-link">美化HighCharts插件  react-beauty-highcharts</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="读marked-js源码-markdown是怎么变成html的"><a href="#读marked-js源码-markdown是怎么变成html的" aria-hidden="true" class="header-anchor">#</a> 读marked.js源码 -- markdown是怎么变成html的</h1> <p>很好奇markdown是怎么变成html的,偶然间看到
<a href="https://github.com/markedjs/marked" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上的这一篇星星✨很高的源码,就来研究研究
下载打开在lib文件夹下的marked.js大概1600行左右的样子,没有组件化,所有的js都是在一个页面,读着很是顺畅哈~(这里没有贬低多个文件的啊,不要生气,嘻嘻😄其实是有的,一个文件就是看着简单)
在html引入js</p> <div class="language-js· extra-class"><pre class="language-text"><code> &lt;script src=&quot;./marked.js&quot;&gt;&lt;/script&gt;
</code></pre></div><p>然后在js中写下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
    <span class="token function">marked</span><span class="token punctuation">(</span><span class="token string">'# Marked in the browser\n\nRendered by **marked**.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>神奇的现象发生了页面变漂亮了???
那么就随marked函数看一看是如何实现的吧
首先我们定位到1461行,看到了一个我们所熟悉亲切的marked函数,接受3个参数,src是markdown, opt是配置{}, callback是回调</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 1461 </span>
<span class="token function">mark</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token comment">// 1544</span>
Parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Lexer<span class="token punctuation">.</span><span class="token function">lex</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回了真正的带有标签的文本,所以接下来研究Lexer对象和Parser.parse</span>
Lexer<span class="token punctuation">.</span><span class="token function">lex</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 163 </span>
Lexer<span class="token punctuation">.</span><span class="token function-variable function">lex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> lexer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lexer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> lexer<span class="token punctuation">.</span><span class="token function">lex</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>Lexer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">lex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  src <span class="token operator">=</span> src
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\r\n|\r/g</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\t/g</span><span class="token punctuation">,</span> <span class="token string">'    '</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\u00a0/g</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\u2424/g</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log('178#', src)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'178#'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">// {type: &quot;heading&quot;, depth: 1, text: &quot;Marked in the browser&quot;}</span>
  <span class="token comment">// {type: &quot;paragraph&quot;, text: &quot;Rendered by  **marked**.&quot;}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>this.token(src, true);返回数组,数组长度为3,[0]是Marked in the browser,
[1]是Rendered by <strong>marked</strong>.字段</p> <p>我们看185行
Lexer.prototype.token
cap = this.rules.heading.exec(src)成立</p> <p>[&quot;# Marked in the browser↵↵&quot;, &quot;#&quot;, &quot;Marked in the browser&quot;, index: 0, input: &quot;# Marked in the browser↵↵Rendered by <strong>marked</strong>.&quot;, groups: undefined]</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>cap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rules<span class="token punctuation">.</span>heading<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'heading'</span><span class="token punctuation">,</span>
    depth<span class="token punctuation">:</span> cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    text<span class="token punctuation">:</span> cap<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>追踪</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">this</span><span class="token punctuation">.</span>rules<span class="token punctuation">.</span>heading<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
  Lexer<span class="token punctuation">.</span>rules <span class="token operator">=</span> block<span class="token punctuation">;</span>
</code></pre></div><p>inline是一个对象,包含一整套匹配规则</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 14</span>
<span class="token keyword">var</span> block <span class="token operator">=</span> <span class="token punctuation">{</span>
  newline<span class="token punctuation">:</span> <span class="token regex">/^\n+/</span><span class="token punctuation">,</span>
  code<span class="token punctuation">:</span> <span class="token regex">/^( {4}[^\n]+\n*)+/</span><span class="token punctuation">,</span>
  fences<span class="token punctuation">:</span> noop<span class="token punctuation">,</span>
  hr<span class="token punctuation">:</span> <span class="token regex">/^ {0,3}((?:- *){3,}|(?:_ *){3,}|(?:\* *){3,})(?:\n+|$)/</span><span class="token punctuation">,</span>
  heading<span class="token punctuation">:</span> <span class="token regex">/^ *(#{1,6}) *([^\n]+?) *(?:#+ *)?(?:\n+|$)/</span><span class="token punctuation">,</span>
  nptable<span class="token punctuation">:</span> noop<span class="token punctuation">,</span>
  blockquote<span class="token punctuation">:</span> <span class="token regex">/^( {0,3}&gt; ?(paragraph|[^\n]*)(?:\n|$))+/</span><span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> <span class="token regex">/^( *)(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?!\1bull )\n*|\s*$)/</span><span class="token punctuation">,</span>
  html<span class="token punctuation">:</span> <span class="token string">'^ {0,3}(?:'</span> <span class="token comment">// optional indentation</span>
    <span class="token operator">+</span> <span class="token string">'&lt;(script|pre|style)[\\s&gt;][\\s\\S]*?(?:&lt;/\\1&gt;[^\\n]*\\n+|$)'</span> <span class="token comment">// (1)</span>
    <span class="token operator">+</span> <span class="token string">'|comment[^\\n]*(\\n+|$)'</span> <span class="token comment">// (2)</span>
    <span class="token operator">+</span> <span class="token string">'|&lt;\\?[\\s\\S]*?\\?&gt;\\n*'</span> <span class="token comment">// (3)</span>
    <span class="token operator">+</span> <span class="token string">'|&lt;![A-Z][\\s\\S]*?&gt;\\n*'</span> <span class="token comment">// (4)</span>
    <span class="token operator">+</span> <span class="token string">'|&lt;!\\[CDATA\\[[\\s\\S]*?\\]\\]&gt;\\n*'</span> <span class="token comment">// (5)</span>
    <span class="token operator">+</span> <span class="token string">'|&lt;/?(tag)(?: +|\\n|/?&gt;)[\\s\\S]*?(?:\\n{2,}|$)'</span> <span class="token comment">// (6)</span>
    <span class="token operator">+</span> <span class="token string">'|&lt;(?!script|pre|style)([a-z][\\w-]*)(?:attribute)*? */?&gt;(?=\\h*\\n)[\\s\\S]*?(?:\\n{2,}|$)'</span> <span class="token comment">// (7) open tag</span>
    <span class="token operator">+</span> <span class="token string">'|&lt;/(?!script|pre|style)[a-z][\\w-]*\\s*&gt;(?=\\h*\\n)[\\s\\S]*?(?:\\n{2,}|$)'</span> <span class="token comment">// (7) closing tag</span>
    <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">,</span>
  def<span class="token punctuation">:</span> <span class="token regex">/^ {0,3}\[(label)\]: *\n? *&lt;?([^\s&gt;]+)&gt;?(?:(?: +\n? *| *\n *)(title))? *(?:\n+|$)/</span><span class="token punctuation">,</span>
  table<span class="token punctuation">:</span> noop<span class="token punctuation">,</span>
  lheading<span class="token punctuation">:</span> <span class="token regex">/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/</span><span class="token punctuation">,</span>
  paragraph<span class="token punctuation">:</span> <span class="token regex">/^([^\n]+(?:\n(?!hr|heading|lheading| {0,3}&gt;|&lt;\/?(?:tag)(?: +|\n|\/?&gt;)|&lt;(?:script|pre|style|!--))[^\n]+)*)/</span><span class="token punctuation">,</span>
  text<span class="token punctuation">:</span> <span class="token regex">/^[^\n]+/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们找到了 this.rules.heading是block里的heading,那么接下来就是exec
exec就是正则!正则!正则!</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token regex">/^ *(#{1,6}) *([^\n]+?) *(?:#+ *)?(?:\n+|$)/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'# Marked in the browser\n\nRendered by **marked**.'</span><span class="token punctuation">)</span>
</code></pre></div><p>正则匹配结果是
数组 [&quot;# Marked in the browser↵↵,&quot;#&quot;,&quot;Marked in the browser&quot;]</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 236</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rules<span class="token punctuation">.</span>heading<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// src是剩下的也就说Rendered by **marked**.,当src长度为0的时候,循环结束</span>
  src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断 是heading </span>
  <span class="token comment">// push type</span>
  <span class="token comment">// depth是正则匹配&quot;#&quot;的长度</span>
  <span class="token comment">// text 是匹配出来的的结果</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'heading'</span><span class="token punctuation">,</span>
    depth<span class="token punctuation">:</span> cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    text<span class="token punctuation">:</span> cap<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来继续解析src,我们看到第491行这里被解析了,上面第正则都未匹配成功</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rules<span class="token punctuation">.</span>paragraph<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'paragraph'</span><span class="token punctuation">,</span>
    text<span class="token punctuation">:</span> cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'\n'</span>
      <span class="token operator">?</span> cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">:</span> cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看一下paragraph和以及被处理的结果
paragraph在block声明的时候被定义了</p> <div class="language- extra-class"><pre class="language-text"><code>{ paragraph: /^([^\n]+(?:\n(?!hr|heading|lheading| {0,3}&gt;|&lt;\/?(?:tag)(?: +|\n|\/?&gt;)|&lt;(?:script|pre|style|!--))[^\n]+)*)/}
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>  <span class="token string">&quot;Rendered by **marked**.&quot;</span>
cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>  <span class="token string">&quot;Rendered by **marked**.&quot;</span>
</code></pre></div><p>此时src为空字符串,直接停止,跳出循环</p> <p>此时this.tokens为</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>tokens <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">&quot;heading&quot;</span><span class="token punctuation">,</span> depth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string">&quot;Marked in the browser&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">&quot;paragraph&quot;</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string">&quot;Rendered by **marked**.&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>此时返回了最初的Parser.parse(Lexer.lex(src, opt), opt);
词法分析器
Lexer.lex(src, opt)调用的结果是this.tokens
接下来就让我们分析Parser.parse吧</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// Static Parse Method 静态方法,为什么不直接new,还需要绕这么一个大圈子</span>
Parser<span class="token punctuation">.</span><span class="token function-variable function">parse</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Parse Loop
 */</span>
<span class="token comment">//1115</span>
Parser<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">parse</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//this.options是默认配置</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineLexer</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>links<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// use an InlineLexer with a TextRenderer to extract pure text</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>inlineText <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineLexer</span><span class="token punctuation">(</span>
    src<span class="token punctuation">.</span>links<span class="token punctuation">,</span>
    <span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token punctuation">{</span>renderer<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">TextRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tokens <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> out <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    out <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//1138</span>
Parser<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// tokens被反转然后pop即吧tokens的[0]赋值给this.token</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokens<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>this.inline和
this.inlineText
很相似都是InlineLexer的实例化,区别在于this.inlineTextlink里有一写配置
// 1167</p> <p>tok原型对象里是对this.token的处理</p> <div class="language-js extra-class"><pre class="language-js"><code>Parser<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">tok</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'space'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'hr'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">hr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 我们来到heading这里,接下来就是分析最重要的render对象了</span>
    <span class="token keyword">case</span> <span class="token string">'heading'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">heading</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inline<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>depth<span class="token punctuation">,</span>
        <span class="token function">unescape</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inlineText<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>lang<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>escaped<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'table'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> header <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
          body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
          i<span class="token punctuation">,</span>
          row<span class="token punctuation">,</span>
          cell<span class="token punctuation">,</span>
          j<span class="token punctuation">;</span>

      <span class="token comment">// header</span>
      cell <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>header<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cell <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">tablecell</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>inline<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>header<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> header<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> align<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>align<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      header <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">tablerow</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>cells<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        row <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>cells<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        cell <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> row<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          cell <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">tablecell</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inline<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> header<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> align<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>align<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">}</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        body <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">tablerow</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'blockquote_start'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'blockquote_end'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        body <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">blockquote</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'list_start'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> ordered <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span>
          start <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>start<span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'list_end'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        body <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'list_item_start'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> loose <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>loose<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        body <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">checkbox</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>checked<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'list_item_end'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        body <span class="token operator">+=</span> <span class="token operator">!</span>loose <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text'</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">listitem</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'html'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO parse inline content if parameter markdown=1</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'paragraph'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
     <span class="token comment">//this.inline.output把**marked**处理成&lt;strong&gt;marked&lt;/strong&gt;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">paragraph</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inline<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">paragraph</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// this.inline.output把**marked**处理成&lt;strong&gt;marked&lt;/strong&gt;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">paragraph</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inline<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Static Lexing/Compiling Method
 */</span>
InlineLexer<span class="token punctuation">.</span><span class="token function-variable function">output</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> links<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> inline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineLexer</span><span class="token punctuation">(</span>links<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> inline<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
output对象里匹配到strong<span class="token punctuation">,</span>调用renderer<span class="token punctuation">.</span>strong
<span class="token comment">// strong</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rules<span class="token punctuation">.</span>strong<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  out <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">strong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>cap<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> cap<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> cap<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// span level renderer</span>
Renderer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">strong</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'&lt;strong&gt;'</span> <span class="token operator">+</span> text <span class="token operator">+</span> <span class="token string">'&lt;/strong&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

    
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 1574</span>
 renderer<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Renderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 marked<span class="token punctuation">.</span>Renderer <span class="token operator">=</span> Renderer<span class="token punctuation">;</span>
 <span class="token comment">// 911</span>
 <span class="token keyword">function</span> <span class="token function">Renderer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> marked<span class="token punctuation">.</span>defaults<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 946</span>
 Renderer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">heading</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> level<span class="token punctuation">,</span> raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果配置中就id就返回带有id</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>headerIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'&lt;h'</span>
      <span class="token operator">+</span> level
      <span class="token operator">+</span> <span class="token string">' id=&quot;'</span>
      <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>headerPrefix
      <span class="token operator">+</span> raw<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[^\w]+/g</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span>
      <span class="token operator">+</span> <span class="token string">'&quot;&gt;'</span>
      <span class="token operator">+</span> text
      <span class="token operator">+</span> <span class="token string">'&lt;/h'</span>
      <span class="token operator">+</span> level
      <span class="token operator">+</span> <span class="token string">'&gt;\n'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ignore IDs</span>
  没有id就直接返回标签加纹板
  <span class="token keyword">return</span> <span class="token string">'&lt;h'</span> <span class="token operator">+</span> level <span class="token operator">+</span> <span class="token string">'&gt;'</span> <span class="token operator">+</span> text <span class="token operator">+</span> <span class="token string">'&lt;/h'</span> <span class="token operator">+</span> level <span class="token operator">+</span> <span class="token string">'&gt;\n'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 同理</span>

<span class="token comment">// paragraph对this.token说[2]做了处理</span>
Renderer<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">paragraph</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> text <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;\n'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>heading接受三个参数text是文本内容,level是heading的级别 1就是H1,2就是H2,raw目前是和level是一样的
经过两轮处理
此时我们的out已经有了结果</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span>h1 id<span class="token operator">=</span><span class="token string">&quot;marked-in-the-browser&quot;</span><span class="token operator">&gt;</span>Marked <span class="token keyword">in</span> the browser<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Rendered by <span class="token operator">&lt;</span>strong<span class="token operator">&gt;</span>marked<span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre></div><p>document.getElementById('content').innerHTML =marked('# Marked in the browser\n\nRendered by <strong>marked</strong>.');
就这样被渲染了.
这个实例就分析完毕了,当然里面还有其他的细节,有兴趣的可以仔细看看,比如什么时候会带有id等等
我们总结一下marked.js是如何处理的
最重要的就是</p> <ol><li>先是正则,把符号匹配出来,#是heading,然后推入this.tokens数组里
每处理一行,推入一个(把scr通过正则处理成this.tokens))</li> <li>对this.tokens的处理,通过正则匹配到就调用相应的render对象里的方法</li> <li>render对象对输入的tokens进行处理返回out处理结果</li></ol> <p>优点</p> <ol><li>每一个功能都分别定义一个函数 render渲染用, laxer词法解析用,实现定义好各种正则,很清晰明明了</li> <li>静态方法的使用</li></ol> <p>总之看着很复杂,当你分析完一个或者写完一个明白一个后,其他的都是依此类推,就是力气活了</p> <p>以上</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/29/2018, 4:25:44 PM</span></div></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/source/react-beauty-highcharts.html">
          美化HighCharts插件  react-beauty-highcharts
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/24.cc9b4c20.js" defer></script><script src="/blog/assets/js/app.b8f6f876.js" defer></script>
  </body>
</html>
